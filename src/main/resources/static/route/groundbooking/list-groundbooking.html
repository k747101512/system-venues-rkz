<!doctype html>
<html lang="en">
<head>
    <base href="/venuebooking/">
    <meta charset="utf-8">
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <link rel="stylesheet" href="assets/fonts/font-awesome/css/font-awesome.css"/>
    <link rel="stylesheet" href="assets/layuiadmin/layui/css/layui.css" media="all">
    <link rel="stylesheet" href="assets/layuiadmin/style/admin.css" media="all">
    <link rel="stylesheet" href="assets/js/vendor/zTree3/css/metroStyle/metroStyle.css"/>
    <link rel="stylesheet" href="assets/layuiadmin/style/common.css" media="all">
</head>
<body>
<div class="layui-fluid layui-anim layui-anim-fadein">
    <div class="layui-row">
        <div class="layui-col-md2">
            <div class="layui-card">
                <div class="layui-card-body left-tree-wrap">
                    <div id="leftTreeWrap">
                        <ul id="leftTree" class="ztree"></ul>
                    </div>
                </div>
            </div>
        </div>
        <div class="layui-col-md10" style="padding-left: 10px;">
            <div class="layui-card">
                <div id="listContentWrap" class="layui-card-body">
                    <div class="layui-form">
                        <div class="layui-form-item">
                            <div class="layui-inline">
                                <label class="layui-form-label">选择日期</label>
                                <div class="layui-input-inline">
                                    <input type="text" name="bookingOrderDate" id="bookingOrderDate" placeholder="请选择日期" lay-verify="date" autocomplete="off" class="layui-input">
                                </div>
                            </div>
                            <div class="layui-inline">
                                <button id="search" class="layui-btn layui-btn-normal layui-btn-sm"><i class="layui-icon">查询</i></button>
                            </div>
                        </div>
                        <table class="layui-table">
                            <colgroup>
                                <col width="300">
                                <col width="300">
                                <col width="300">
                                <col width="150">
                            </colgroup>
                            <thead>
                            <tr>
                                <th style="text-align: center">场次时段</th>
                                <th style="text-align: center">价格</th>
                                <th style="text-align: center">操作</th>
                            </tr>
                            </thead>
                            <tbody id="table-tbody-div"></tbody>
                            <script id="table-tbody-div-tpl" type="text/html">
                                {{# layui.each(d,function(index, item){ }}
                                <tr>
                                    <td style="text-align: center">{{item.timeStr}} ~ {{item.timeEnd}}</td>
                                    <td style="text-align: center">{{item.singlePrice}} 元</td>
                                    <td style="text-align: center">
                                        <a class="layui-btn layui-btn-xs booking-btn" data-singleprice="{{item.singlePrice}}"
                                           data-timestr="{{item.timeStr}}" data-timeend="{{item.timeEnd}}">预订</a>
                                    </td>
                                </tr>
                                {{# }); }}
                            </script>
                        </table>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="assets/layuiadmin/layui/layui.js"></script>
<script src="assets/js/vendor/viewer/viewer.min.js"></script>
<script>
    layui.config({
        base: 'assets/layuiadmin/'
    }).extend({
        index: 'lib/index'
    }).use(['index', 'table', 'admin', 'ztree', 'laytpl','laydate'], function() {
        var $ = layui.$;
        var $win = $(window);
        var admin = layui.admin;
        var table = layui.table;
        var laytpl = layui.laytpl;
        var laydate = layui.laydate;
        var resizeTimeout = null;
        var groundInfoId = '';
        var date = new Date();
        var bookingOrderDate = date.getFullYear() + '-' +
            (parseInt(date.getMonth()+"") + 1) + '-' +
            date.getDate();

        //初始化查询日期
        laydate.render({
            elem: '#bookingOrderDate',
            value : bookingOrderDate,
            format: 'yyyy-MM-dd',
            min: 0,
            max: 3,
            ready: function(date){
                console.log(date);
            }
        });

        function initThree() {
            var nodeObj = [];
            var setting = {
                view: {
                    showLine: true,
                    showIcon: true,
                    nameIsHTML: true
                },
                data: {
                    simpleData: {
                        enable: true  //简单数据模式
                    }
                },
                callback: {
                    onClick: function(event, treeId, treeNode){
                        if(typeof (treeNode.isGround) != 'undefined' && treeNode.isGround === '1'){
                            groundInfoId = treeNode.id;
                            initGroundList();
                        }
                    }
                }
            };
            top.restAjax.get(top.restAjax.path('api/groundbooking/gettreegroundinfo', []), {}, null, function(code, data) {
                if(typeof (data) != 'undefined' && typeof (data.zTreeList) != 'undefined'){
                    nodeObj = data.zTreeList;
                }
                var treeObj = $.fn.zTree.init($("#leftTree"), setting, nodeObj);
                treeObj.expandAll(true);
            }, function(code, data) {
                top.dialog.msg(data.msg);
            });
        };
        initThree();

        function initGroundList(){
            if(groundInfoId == '')
                return false;
            var loadLayerIndex;
            var param = {
                bookingOrderDate : $('#bookingOrderDate').val(),
                groundInfoId : groundInfoId
            }
            top.restAjax.get(top.restAjax.path('api/groundbooking/listgroundbooking', []), param, null, function(code, data) {
                laytpl(document.getElementById('table-tbody-div-tpl').innerHTML).render(data.list, function(html) {
                    document.getElementById('table-tbody-div').innerHTML = html;
                });
            }, function(code, data) {
                top.dialog.msg(data.msg);
            }, function() {
                loadLayerIndex = top.dialog.msg(top.dataMessage.loading, {icon: 16, time: 0, shade: 0.3});
            }, function() {
                top.dialog.close(loadLayerIndex);
            });
        }

        $(document).on('click','.booking-btn',function(){
            var bookingOrderDate = $('#bookingOrderDate').val();
            var singlePrice = this.dataset.singleprice;
            var timeStr = this.dataset.timestr;
            var timeEnd = this.dataset.timeend;
            layer.open({
                type: 2,
                title: false,
                closeBtn: 0,
                area: ['80%', '80%'],
                shadeClose: true,
                anim: 2,
                content: top.restAjax.path(
                    'route/venuesproject/save-bookingInfo.html' +
                    '?groundInfoId={groundInfoId}' +
                    '&timeStr={timeStr}' +
                    '&timeEnd={timeEnd}' +
                    '&singlePrice={singlePrice}' +
                    '&bookingOrderDate={bookingOrderDate}',
                    [groundInfoId,timeStr,timeEnd,singlePrice,bookingOrderDate]),
                end: function() {
                    //reloadTable();
                }
            });
        });

        // 事件 - 搜索按钮
        $(document).on('click', '#search', function() {
            initGroundList();
        });

        $(document).on('click', '#backProjectList', function() {
            closeBox();
        });

        function closeBox() {
            parent.layer.close(parent.layer.getFrameIndex(window.name));
        }

        // 事件 - 页面变化
        $win.on('resize', function() {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(function() {
                reloadTable();
            }, 500);
        });

        function initSize() {
            $('#leftTreeWrap').css({
                height: $win.height() - 30,
                overflow: 'auto'
            });
            $('#listContentWrap').css({
                height: $win.height() - 50,
            });
        }
        initSize();
    });

</script>
</body>
</html>